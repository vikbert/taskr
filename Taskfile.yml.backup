# yaml-language-server: $schema=https://taskr-io.vercel.app/schema.json
version: '3'
banner: true
categories: ["core"]

includes:
  website:
    aliases: [w, docs, d]
    taskfile: ./website
    dir: ./website

vars:
  BIN: "{{.ROOT_DIR}}/bin"
  GOTESTSUM_FORMAT: '{{if .CI}}github-actions{{else}}pkgname{{end}}'
  INSTALL_PATH:
    sh: go env GOPATH
  TASKR_BINARY: "{{.INSTALL_PATH}}/bin/taskr{{exeExt}}"

env:
  CGO_ENABLED: '0'

tasks:
  default:
    category: core
    cmds:
      - taskr --list

  run:
    category: core
    desc: Runs Task
    cmds:
      - go run ./cmd/taskr {{.CLI_ARGS}}

  install:
    category: core
    desc: Installs taskr (incremental build, skips if up-to-date)
    aliases: [i]
    sources:
      - './**/*.go'
      - 'go.mod'
      - 'go.sum'
    generates:
      - "{{.TASKR_BINARY}}"
    method: checksum
    cmds:
      - go install -v ./cmd/taskr

  reinstall:
    category: core
    desc: Force reinstall taskr binary (always rebuilds and installs)
    aliases: [ri]
    cmds:
      - cmd: echo "üóëÔ∏è  Removing old binary..."
        silent: true
      - rm -f {{.TASKR_BINARY}}
      - cmd: echo "üî® Rebuilding and installing taskr..."
        silent: true
      - go install -v ./cmd/taskr
      - cmd: echo "‚úÖ taskr reinstalled successfully!"
        silent: true
      - cmd: echo "üìç Location{{":"}} {{.TASKR_BINARY}}"
        silent: true
      - cmd: taskr --version
        silent: true

  verify-install:
    category: core
    desc: Verify taskr is installed and working correctly
    aliases: [verify, check-install]
    cmds:
      - cmd: echo "üìç Checking installation..."
        silent: true
      - cmd: |
          if [ -f "{{.TASKR_BINARY}}" ]; then
            echo "‚úÖ Binary exists{{":"}} {{.TASKR_BINARY}}"
            echo "üì¶ Version{{":"}}";
            taskr --version;
            echo "‚úÖ Installation verified!";
          else
            echo "‚ùå Binary not found{{":"}} {{.TASKR_BINARY}}";
            echo "üí° Run 'taskr install' or 'taskr reinstall' to install";
            exit 1;
          fi
        silent: true

  build:
    category: core
    desc: Build taskr binary to ./bin directory (for local testing)
    aliases: [b]
    sources:
      - './**/*.go'
      - 'go.mod'
      - 'go.sum'
    generates:
      - "{{.BIN}}/taskr{{exeExt}}"
    cmds:
      - mkdir -p {{.BIN}}
      - go build -v -o {{.BIN}}/taskr{{exeExt}} ./cmd/taskr
      - cmd: echo "‚úÖ Built{{":"}} {{.BIN}}/taskr{{exeExt}}"
        silent: true

  dev:
    category: core
    desc: Quick development cycle (reinstall + run with args)
    cmds:
      - task: reinstall
      - taskr {{.CLI_ARGS}}

  generate:
    category: generate
    aliases: [gen, g]
    desc: Runs all generate tasks
    cmds:
      - task: generate:mocks
      - task: generate:fixtures

  generate:mocks:
    category: generate
    desc: Runs Mockery to create mocks
    aliases: [gen:mocks, g:mocks]
    deps: [install:mockery]
    sources:
      - "internal/fingerprint/checker.go"
    generates:
      - "internal/mocks/*.go"
    cmds:
      - find . -type f -name *_mock.go -delete
      - "{{.BIN}}/mockery"

  generate:fixtures:
    category: generate
    desc: Runs tests and generates golden fixture files
    aliases: [gen:fixtures, g:fixtures]
    env:
      GOLDIE_UPDATE: 'true'
      GOLDIE_TEMPLATE: 'true'
    cmds:
      - find ./testdata -name '*.golden' -delete
      - go test ./...

  install:mockery:
    category: generate
    index: 1
    desc: Installs mockgen; a tool to generate mock files
    vars:
      MOCKERY_VERSION: v3.2.2
    env:
      GOBIN: "{{.BIN}}"
    status:
      - go version -m {{.BIN}}/mockery | grep github.com/vektra/mockery | grep {{.MOCKERY_VERSION}}
    cmds:
      - GOBIN="{{.BIN}}" go install github.com/vektra/mockery/v3@{{.MOCKERY_VERSION}}

  mod:
    category: maintenance
    desc: Downloads and tidy Go modules
    cmds:
      - go mod download
      - go mod tidy

  clean:
    category: maintenance
    desc: Cleans temp files and folders
    aliases: [clear]
    cmds:
      - rm -rf dist/
      - rm -rf tmp/

  clean:all:
    category: maintenance
    desc: Cleans temp files, folders, and installed binaries
    aliases: [clean-all, clear-all]
    cmds:
      - task: clean
      - rm -f {{.TASKR_BINARY}}
      - rm -f {{.BIN}}/taskr{{exeExt}}
      - cmd: echo "‚úÖ All clean!"
        silent: true

  lint:
    category: core
    desc: Runs golangci-lint
    aliases: [l]
    sources:
      - './**/*.go'
      - .golangci.yml
      - go.mod
    cmds:
      - golangci-lint run

  lint:fix:
    category: core
    desc: Runs golangci-lint and fixes any issues
    sources:
      - './**/*.go'
      - .golangci.yml
      - go.mod
    cmds:
      - golangci-lint run --fix

  format:
    category: core
    desc: Runs golangci-lint and formats any Go files
    aliases: [fmt, f]
    sources:
      - './**/*.go'
      - .golangci.yml
    cmds:
      - golangci-lint fmt

  sleepit:build:
    category: maintenance
    desc: Builds the sleepit test helper
    sources:
      - ./cmd/sleepit/**/*.go
    generates:
      - "{{.BIN}}/sleepit{{exeExt}}"
    cmds:
      - go build -o {{.BIN}}/sleepit{{exeExt}} ./cmd/sleepit

  sleepit:run:
    category: maintenance
    desc: Builds the sleepit test helper
    deps: [sleepit:build]
    cmds:
      - "{{.BIN}}/sleepit {{.CLI_ARGS}}"
    silent: true

  test:
    category: test
    desc: Runs test suite
    aliases: [t]
    deps: [gotestsum:install]
    sources:
      - "**/*.go"
      - "testdata/**/*"
    cmds:
      - gotestsum -f '{{.GOTESTSUM_FORMAT}}' ./...

  test:watch:
    category: test
    desc: Runs test suite with watch tests included
    deps: [sleepit:build, gotestsum:install]
    cmds:
      - gotestsum -f '{{.GOTESTSUM_FORMAT}}' ./... -tags 'watch'

  test:all:
    category: test
    desc: Runs test suite with signals and watch tests included
    deps: [sleepit:build, gotestsum:install]
    cmds:
      - gotestsum -f '{{.GOTESTSUM_FORMAT}}' -tags 'signals watch' ./...

  goreleaser:test:
    category: release
    desc: Tests release process without publishing
    cmds:
      - goreleaser --snapshot --clean

  gotestsum:install:
    category: release
    desc: Installs gotestsum
    status:
      - command -v gotestsum
    cmds:
      - go install gotest.tools/gotestsum@latest

  goreleaser:install:
    category: release
    desc: Installs goreleaser
    cmds:
      - go install github.com/goreleaser/goreleaser/v2@latest

  gorelease:install:
    category: release
    desc: "Installs gorelease: https://pkg.go.dev/golang.org/x/exp/cmd/gorelease"
    status:
      - command -v gorelease
    cmds:
      - go install golang.org/x/exp/cmd/gorelease@latest

  apicheck:
    category: core
    desc: Checks what changes have been made to the public API
    deps: [gorelease:install]
    vars:
      LATEST:
        sh: git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0"
    cmds:
      - gorelease -base={{.LATEST}}

  release:*:
    category: release
    desc: Prepare the project for a new release
    summary: |
      This task will do the following:

      - Update the version and date in the CHANGELOG.md file
      - Update the version in the package.json and package-lock.json files
      - Copy the latest docs to the "current" version on the website
      - Commit the changes
      - Create a new tag
      - Push the commit/tag to the repository
      - Create a GitHub release

      To use the task, run "taskr release:<version>" where "<version>" is is one of:

      - "major" - Bumps the major number
      - "minor" - Bumps the minor number
      - "patch" - Bumps the patch number
      - A semver compatible version number (e.g. "1.2.3")
    vars:
      VERSION:
        sh: "go run ./cmd/release --version {{index .MATCH 0}}"
      COMPLETE_MESSAGE: |
        Creating release with GoReleaser: https://github.com/vikbert/taskr/actions/workflows/release.yml

        Please wait for the CI to finish and then do the following:

        - Copy the changelog for v{{.VERSION}} to the GitHub release
        - Run 'taskr release:package-managers' to publish to package managers
    preconditions:
      - sh: test $(git rev-parse --abbrev-ref HEAD) = "main"
        msg: "You must be on the main branch to release"
      - sh: "[[ -z $(git diff --shortstat main) ]]"
        msg: "You must have a clean working tree to release"
    prompt: "Are you sure you want to release version {{.VERSION}}?"
    cmds:
      - cmd: echo "Releasing v{{.VERSION}}"
        silent: true
      - "go run ./cmd/release {{.VERSION}}"
      - "git add --all"
      - "git commit -m v{{.VERSION}}"
      - "git push"
      - "git tag v{{.VERSION}}"
      - "git push origin tag v{{.VERSION}}"
      - cmd: printf "%s" '{{.COMPLETE_MESSAGE}}'
        silent: true

  release:package-managers:
    category: release
    desc: Manual steps to publish Taskr to various package managers
    summary: |
      This task provides step-by-step instructions for manually publishing Taskr
      to various package managers after a release has been created.

      Required: Run this after 'taskr release:<version>' has completed and GoReleaser has finished.
    cmds:
      - cmd: echo "üöÄ Taskr Package Manager Publishing Guide"
        silent: true
      - cmd: |
          echo ""
          echo "üìã Prerequisites:"
          echo "   - Release created with: taskr release:<version>"
          echo "   - GoReleaser CI completed: https://github.com/vikbert/taskr/actions/workflows/release.yml"
          echo "   - Release tag created and pushed"
          echo ""
          echo "üì¶ Package Managers to Update:"
          echo ""
        silent: true
      - cmd: |
          echo "1. üè† Homebrew (macOS/Linux)"
          echo "   ‚Ä¢ Fork: https://github.com/go-task/homebrew-tap"
          echo "   ‚Ä¢ Create your tap: https://github.com/vikbert/homebrew-taskr"
          echo "   ‚Ä¢ Update Formula/taskr.rb with new version and SHA256"
          echo "   ‚Ä¢ Submit PR to your tap repository"
          echo ""
        silent: true
      - cmd: |
          echo "2. üì¶ npm (Cross-platform)"
          echo "   ‚Ä¢ Publish to npm: npm publish"
          echo "   ‚Ä¢ Package name: @vikbert/taskr or @taskr/cli"
          echo "   ‚Ä¢ Update package.json with correct version"
          echo ""
        silent: true
      - cmd: |
          echo "3. üì± Snap (Linux)"
          echo "   ‚Ä¢ Repository: https://github.com/vikbert/snap"
          echo "   ‚Ä¢ Update snap/snapcraft.yaml with new version"
          echo "   ‚Ä¢ Push changes to trigger automated build"
          echo ""
        silent: true
      - cmd: |
          echo "4. ü™ü WinGet (Windows)"
          echo "   ‚Ä¢ Repository: https://github.com/microsoft/winget-pkgs"
          echo "   ‚Ä¢ Submit PR to add/update Taskr.Task package manifest"
          echo "   ‚Ä¢ Use the installer URL from GitHub releases"
          echo ""
        silent: true
      - cmd: |
          echo "5. üåê Cloudsmith (RPM/DEB)"
          echo "   ‚Ä¢ Create Taskr repository: https://cloudsmith.io/~vikbert/repos/taskr"
          echo "   ‚Ä¢ Upload RPM/DEB packages from GoReleaser artifacts"
          echo "   ‚Ä¢ Update repository metadata"
          echo ""
        silent: true
      - cmd: |
          echo "6. ü§ù Community Package Managers"
          echo "   ‚Ä¢ Chocolatey: Submit PR to https://github.com/chocolatey-community/chocolatey-coreteampackages"
          echo "   ‚Ä¢ Scoop: Submit PR to https://github.com/ScoopInstaller/Main"
          echo "   ‚Ä¢ Arch Linux: Submit PR to https://gitlab.archlinux.org/archlinux/packaging/packages/go-task"
          echo "   ‚Ä¢ Fedora: Submit PR to https://src.fedoraproject.org/rpms/golang-github-task"
          echo "   ‚Ä¢ Nix: Submit PR to https://github.com/NixOS/nixpkgs"
          echo "   ‚Ä¢ FreeBSD: Submit PR to https://cgit.freebsd.org/ports/tree/devel/task"
          echo ""
        silent: true
      - cmd: |
          echo "üîß Automation Helpers:"
          echo "   ‚Ä¢ GitHub Action: Create fork of go-task/setup-task"
          echo "   ‚Ä¢ Mise integration: Already configured for vikbert/taskr"
          echo "   ‚Ä¢ pkgx: Already configured for taskr-io.vercel.app"
          echo ""
          echo "üìã Quick Commands Reference:"
          echo ""
          echo "   # Check current release status"
          echo "   gh release list --repo vikbert/taskr"
          echo ""
          echo "   # Download release artifacts (if needed)"
          echo "   gh release download v{{.VERSION}} --repo vikbert/taskr"
          echo ""
          echo "   # Update Homebrew formula example:"
          echo "   brew bump-formula-pr --url https://github.com/vikbert/taskr/archive/v{{.VERSION}}.tar.gz taskr"
          echo ""
          echo "üìù Remember to update installation docs after publishing!"
        silent: true

  publish:*:
    category: release
    desc: Complete end-to-end publishing workflow for Taskr releases
    summary: |
      This task runs the complete publishing workflow including:

      - Pre-release validation (tests, linting, API checks)
      - Version bump and release preparation
      - Git operations and tagging
      - Package manager publishing guidance

      Usage: taskr publish:<version> where <version> is:
      - "patch" - Bug fixes (x.x.1)
      - "minor" - New features (x.1.x)
      - "major" - Breaking changes (1.x.x)
      - Specific version like "1.2.3"
    vars:
      VERSION:
        sh: "go run ./cmd/release --version {{index .MATCH 0}}"
    preconditions:
      - sh: test $(git rev-parse --abbrev-ref HEAD) = "main"
        msg: "You must be on the main branch to publish"
      - sh: "[[ -z $(git diff --shortstat main) ]]"
        msg: "You must have a clean working tree to publish"
    prompt: "Are you sure you want to publish version {{.VERSION}}? This will create a new release."
    cmds:
      - cmd: echo "üöÄ Starting Taskr v{{.VERSION}} publishing workflow..."
        silent: true
      - cmd: echo "üìã Phase 1: Pre-release validation"
        silent: true

      # Phase 1: Pre-release validation
      - cmd: echo "   ‚úÖ Running test suite..."
        silent: true
      - gotestsum -f pkgname ./...

      - cmd: echo "   ‚úÖ Running linting checks..."
        silent: true
      - golangci-lint run

      - cmd: echo "   ‚úÖ Checking API compatibility..."
        silent: true
      - go run golang.org/x/exp/cmd/gorelease@latest -base=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")

      - cmd: echo "   ‚úÖ Formatting code..."
        silent: true
      - golangci-lint fmt

      - cmd: echo "üìã Phase 2: Creating release"
        silent: true

      # Phase 2: Release creation (using existing release:* task logic)
      - cmd: echo "   üìù Updating version and changelog..."
        silent: true
      - "go run ./cmd/release {{index .MATCH 0}}"

      - cmd: echo "   üíæ Committing changes..."
        silent: true
      - git add --all
      - "git commit -m v{{.VERSION}}"

      - cmd: echo "   üè∑Ô∏è  Creating and pushing tag..."
        silent: true
      - "git push"
      - "git tag v{{.VERSION}}"
      - "git push origin tag v{{.VERSION}}"

      - cmd: echo "üìã Phase 3: CI and Package Manager Publishing"
        silent: true
      - cmd: |
          echo ""
          echo "üéâ Release v{{.VERSION}} created successfully!"
          echo ""
          echo "üìã Next Steps:"
          echo ""
          echo "1. üîÑ Wait for GoReleaser CI to complete:"
          echo "   https://github.com/vikbert/taskr/actions/workflows/release.yml"
          echo ""
          echo "2. üì¶ Publish to package managers:"
          echo "   taskr release:package-managers"
          echo ""
          echo "3. üìù Update installation documentation if needed"
          echo ""
          echo "4. üì¢ Announce the release (optional)"
          echo ""
          echo "üìä Monitor progress:"
          echo "   ‚Ä¢ Release: https://github.com/vikbert/taskr/releases/tag/v{{.VERSION}}"
          echo "   ‚Ä¢ CI Status: gh workflow view release.yml --repo vikbert/taskr"
        silent: true
